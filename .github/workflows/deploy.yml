name: Deploy

on:
  workflow_dispatch:

jobs:
  deploy-frontend:
    if: ${{ secrets.FIREBASE_TOKEN != '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20.19.0"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend deps
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy Hosting
        run: firebase deploy --only hosting --project dev-interview-ai
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

  deploy-backend:
    if: ${{ secrets.GCP_SA_KEY != '' }}
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: dev-interview-ai
      REGION: us-central1
      SERVICE_NAME: dev-interview-backend
      IMAGE: gcr.io/dev-interview-ai/dev-interview-backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      - name: Build image
        run: gcloud builds submit backend --tag ${{ env.IMAGE }}

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.IMAGE }} \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --project ${{ env.PROJECT_ID }}
